var QuantityHTMLToStart =(cartItems)=>{
    const totalQuantityHTML= document.getElementById('totalQuantity');
    var totalQuantity="";
    var totalQuantity0 = 0;
    var productListLength=0;
    productListLength = cartItems.childElementCount;

    const inputCollection = document.getElementsByName('itemQuantity');
    
    for(let i=0; i<productListLength;i++){
        var input = inputCollection[i];
        var settingsQuantity=input.parentElement;
        var contentSettings =settingsQuantity.parentElement;
        var contentDescription = contentSettings.previousElementSibling;
        var descriptionTheName = contentDescription.getElementsByTagName('h2')[0];
        var descriptionTheColor = contentDescription.getElementsByTagName('p')[0];

        var name = descriptionTheName.textContent;
        var idName = name.substring(6);
        var color = descriptionTheColor.textContent;

        var res = localStorage.getItem(idName+','+color);
        var index1 =res.search(/[,]/);
        var substringNot1 = res.substring(index1+1);
        var index2 = substringNot1.search(/[,]/);
        var quantity= substringNot1.substring(index2+1);        
        var quantity0 = parseInt(quantity);

        totalQuantity0 += quantity0;
    }
    
    totalQuantity= totalQuantity0.toString();
    totalQuantityHTML.textContent= totalQuantity;

    return totalQuantityHTML;
}

var PriceHTMLToStart =(cartItems)=>{
    const totalPriceHTML = document.getElementById('totalPrice');

    var totalPrice0 = 0;
    var totalPrice = "";

    var productListLength = 0;
    productListLength = cartItems.childElementCount;
    
    const inputCollection = document.getElementsByName('itemQuantity');
    
    for(let i=0; i<productListLength;i++){
        var input = inputCollection[i];
        var settingsQuantity=input.parentElement;
        var contentSettings =settingsQuantity.parentElement;
        var contentDescription = contentSettings.previousElementSibling;
        var descriptionTheName = contentDescription.getElementsByTagName('h2')[0];
        var descriptionTheColor = contentDescription.getElementsByTagName('p')[0];
        var descriptionThePrice = contentDescription.getElementsByTagName('p')[1];

        var name = descriptionTheName.textContent;
        var idName = name.substring(6);
        var price = descriptionThePrice.textContent;
        var price0 = toPriceNumber(price);
        var color = descriptionTheColor.textContent;

        var res = localStorage.getItem(idName+','+color);
        var index1 =res.search(/[,]/);
        var substringNot1 = res.substring(index1+1);
        var index2 = substringNot1.search(/[,]/);
        var quantity= substringNot1.substring(index2+1);        
        var quantity0 = parseInt(quantity);
        
        totalPrice0 += quantity0*price0;
    }
    totalPrice = toPriceString(totalPrice0);
    
    totalPriceHTML.textContent= totalPrice;

    return totalPriceHTML;
}

--------------------------------------------------------------------------------------------------------

//vRvY

    var id_i ="";
    var color_i ="";
    var name_i="";    
    var idName_i="";
    var price_i="";
    var price0_i=0;   
    var quantity_i = "";   
    var quantity0_i=0;


        var input_i = cartItems.children[i].getElementsByTagName('input')[0];
        var suppr_i = cartItems.children[i].getElementsByTagName('p')[3];
        id_i = cartItems.children[i].querySelector('article').dataset.id.value;
        color_i = cartItems.children[i].querySelector('article').dataset.color.value;
        name_i = cartItems.children[i].getElementsByTagName('input')[0].textContent;
        idName_i = name_i.substring(6);
        price_i = cartItems.children[i].getElementsByTagName('p')[1].textContent;
        price0_i = toPriceNumber(price_i);
        quantity_i = input_i.value;
        quantity0_i = parseInt(quantity_i);

        input_i.addEventListener('change', function(e){
            quantity_i = e.target.value;
            quantity0_i =parseInt(quantity_i);
            localStorage.setItem(idName_i+','+color_i, [id_i,color_i,quantity_i])
        });

        totalQuantity0 += quantity0_i;
        totalPrice0 += quantity0_i*price0_i;

        suppr_i.addEventListener('click', function(e){
            cartItems.removeChild(item_i);
            localStorage.removeItem(idName_i+','+color_i);
        })

//vRvY

//vRvY
        var quantity = item.nodeValue;
        var quantity0 = parseInt(quantity);

        var article =item.closest('article');
        var color = article.dataset.color;
        var name =item.closest('h2').nodeValue;
        var idName = name.substring(6);
        var id = article.dataset.id;
        var price = item.closest('.cart__item__content__description > p:last').nodeValue;
        var price0 = toPriceNumber(price);
        
        item.addEventListener('change', (e) =>{
            var quantityNow = e.target.value;
            var quantityNow0 =parseInt(quantityNow);

            totalQuantity0 = totalQuantity0 - quantity0 +quantityNow0;
            totalPrice0 = totalPrice0 -quantity0*price0 + quantityNow0*price0

            var totalQuantityNow = totalQuantity0.toString();
            var totalPriceNow = toPriceString(totalPrice0);
            localStorage.setItem(idName+','+color, [id,color,quantityNow])
            
            totalQuantityHTML.textContent=totalQuantityNow;
            totalPriceHTML.textContent =totalPriceNow;
        })
    })

    var erasors = document.querySelectorAll('.deleteItem');

    erasors.forEach(item => {
        var article =item.closest('article');
        var input = article.querySelector('input');
        var quantity = input.value;
        var quantity0 = parseInt(quantity);
        var article =item.closest('.cart__item');
        var color = article.dataset.color;
        var name = item.closest('h2').nodeValue;
        var idName = name.substring(6);
        var price = item.closest('.cart__item__content__description p:last').nodeValue;
        var price0 = toPriceNumber(price);

        item.addEventListener('click', (e) =>{
            totalQuantity0 = totalQuantity0 -quantity0;
            totalPrice0 = totalPrice0 - quantity0*price0;

            var totalQuantityNow = totalQuantity0.toString();
            var totalPriceNow = toPriceString(totalPrice0);
            
            totalQuantityHTML.textContent=totalQuantityNow;
            totalPriceHTML.textContent =totalPriceNow;

            article.parentNode.removeChild(article);
            
            localStorage.removeItem(idName+','+color)
        })
    })
//vRvY

        var line = localStorage.getItem(idName +','+ color);
        var part1 =line.search(/[,]/);
        var part2 = line.substring(part1+1);
        var part2FirstPart = part2.search(/[,]/);
        var part2LastPart= part2.substring(part2FirstPart+1);        
        var quantity0 = parseInt(part2LastPart);

   const totalQuantityHTML = document.getElementById('totalQuantity');
    const totalPriceHTML = document.getElementById('totalPrice');
    var totalQuantity0 =0;
    var totalPrice0 =0;
    const cartItems = document.getElementById('cart__items');    
    for(let i=0; i<finalStorageArr.length; i++){
        
        const cartItem = document.createElement('article');
        cartItem.classList.add('cart__item');
        cartItems.appendChild(cartItem);

        var line ="";
        line = finalStorageArr[i];
        var part1EndIndex =line.search(/[,]/);
        var part2 = line.substring(part1EndIndex+1);
        var part2FirstPartEndIndex = part2.search(/[,]/);
        var quantity= part2.substring(part2FirstPartEndIndex+1);
        
        var id = line.substring(0,part1EndIndex);
        var color= part2.substring(0,part2FirstPartEndIndex);              
        var quantity0 = parseInt(quantity);

        totalQuantity0 += quantity0;
        
        console.log('id arr ='+id);
        console.log('color arr ='+color);
        console.log('quantity arr = '+ quantity);
        console.log('quantity0, from quantity arr, ='+quantity0);

        var nameKanap="";
        var price0 = 0;
        var price = "";
        var imageUrlKanap = "";
        var altTxtKanap = "";

        cartItem.setAttribute('data-id',id);
        cartItem.setAttribute('data-color',color); 
    
        //*Boucle for : à chaque ligne du LocalStorage (panier) on extrait l'id, la couleur et la quantité;
        //***recherche de l'élement du panier dans le catalogue (data) grâce à l'id
        //**je crée une vignette cartItem 'article.cart__item' pour chaque produit-panier correspondant chacunes à une ligne du tableau-panier (localStorage)
        var j=0;
        do{//***
            if(data[j]._id == id){
                price0 = data[j].price;

                totalPrice0 += price0*quantity0;

                price = toPriceString(price0);
                console.log('price0 from data = '+price0)
                console.log('from price0 from data : price = '+price);

                nameKanap = data[j].name;        imageUrlKanap = data[j].imageUrl;
                altTxtKanap = data[j].altTxt;

                var itemImage =addImageTocartItem(imageUrlKanap, altTxtKanap);
                itemImage.classList.add('cart__item__img');
            
                var itemContent =addContentTocartItem(color, quantity, nameKanap, price);
                itemContent.classList.add('cart__item__content');
                
                cartItem.appendChild(itemImage);
                //**
                cartItem.appendChild(itemContent);
                //***

                //*pour chaque produit-panier que l'on ajoute le prix global augmente du prix correspondant à ce seul produit panier: la quantité d'occurences de ce produit panier (quantité de ce même produit)*le prix unitaire de ce produit-panier;
                //**à un id donné correspond une section image donnée
                //***à un id donné correspond une section content donnée
            }
            j++;    
        }while(j<data.length);
    }
    var totalQuantity = totalQuantity0.toString();
    totalQuantityHTML.textContent= totalQuantity;
    var totalPrice = toPriceString(totalPrice0);
    var string = totalPrice + ',00';
    totalPriceHTML.textContent= string;

    return cartItems;
}

---------------------------------------------------------------------------------------------------------

    itemCollection.forEach(item => {
        var inputHTML = item.closest("input");
        var quantity = inputHTML.value;
        var quantity0 = parseInt(quantity);
        var color = item.dataset.color;
        var id = item.dataset.id;
        var name =item.querySelector('h2').textContent;
        var idName = name.substring(6);
        var string = item.querySelector('.cart__item__content__description').querySelectorAll('p')[1].textContent;
        var price = string.substring(0,string.match(/\s/g).length -1 -4);
        var price0 = parseInt(price);

        console.log('idName foreach item = '+idName);
        console.log('color foreach item = '+color);        
        console.log('id foreach item = '+id);
        console.log('price foreach item = '+price);
        console.log('price0 foreach item: '+ price0); 
        console.log('quantity foreach item ='+quantity)
        console.log('quantity0 foreach item ='+quantity0)

        inputHTML.addEventListener('change', function (e) {
            var quantityNow0 = 0;
            var quantityNow = e.target.value;
            quantityNow0 =parseInt(quantityNow);

            var totalQuantityNow0 = totalQuantity0 - quantity0 +quantityNow0;
            var totalPriceNow0 = totalPrice0 -quantity0*price0 + quantityNow0*price0

            totalQuantityHTML.textContent=totalQuantityNow0.toString();
            totalPriceHTML.textContent = toPriceString(totalPriceNow0) +',00';

            finalStorageArr.splice(finalStorageArr.indexOf(id+','+color+','+quantity),1, [id+','+color+','+quantityNow]);
            localStorage.setItem(idName+','+color,[id+','+color+','+quantityNow]);
            
            console.log('totalQuantityNow0 foreach item -listen quantityinput-= '+totalQuantityNow0);
            console.log('totalPriceNow0 foreach item -listen quantityinput-= '+totalPriceNow0);
            console.log('idName foreach item -listen quantityinput-= '+idName);
            console.log('color foreach item -listen quantityinput- = '+color);        
            console.log('id foreach item  -listen quantityinput-= '+id);
            console.log('price foreach item -listen quantityinput- = '+price);
            console.log('price0 foreach item -listen quantityinput- = '+ price0);
            console.log('quantityNow0 foreach item -listen quantityinput- ='+quantityNow0) 
            console.log('quantity0 foreach item -listen quantityinput- ='+quantity0)
        })
        var erasor = item.querySelector(".deleteItem");
    
        erasor.addEventListener('click', (_e) =>{
            totalQuantityNow0 = totalQuantity0 -quantity0;
            totalPriceNow0 = totalPrice0 - quantity0*price0;

            totalQuantityHTML.textContent= totalQuantityNow0.toString();
            totalPriceHTML.textContent = toPriceString(totalPriceNow0) + ',00';
 
            cartItems.removeChild(item);
            
            console.log('totalQuantityNow0 foreach item -listen erasor-= '+totalQuantityNow0);
            console.log('totalPriceNow0 foreach item -listen erasor-= '+totalPriceNow0);
            console.log('totalQuantity foreach item -listen erasor-= '+totalQuantity);
            console.log('totalPrice foreach item -listen erasor-= '+totalPrice);
            console.log('idName foreach item -listen erasor- = '+idName);
            console.log('color foreach item -listen erasor- = '+color);
            console.log('price foreach item -listen erasor- = '+price);
            console.log('price0 foreach item -listen erasor- = '+ price0); 
            console.log('quantity0 foreach item -listen erasor- = '+quantity0);  

            finalStorageArr.splice(finalStorageArr.indexOf(id+','+color+','+quantity),1)
            localStorage.removeItem(idName+','+color);
        })
    }) 



        
    const plier = async(LineValue0)=> {
        const retrieveData = () =>fetch("http://localhost:3000/api/products")
            .then(res =>{
                if (res.ok){
                    return res.json();
                }
            })
            .then (data => {
                console.log(data);
                return data;})
            .catch (err => console.log('erreur suivante:'+ err))
        
        const data = await retrieveData();

        const setPurchase=(LineValue0)=> {
            var finalStorageArr = new Array([""]);
            finalStorageArr[0] = LineValue0;      
            for(let i=1; i<localStorage.length; i++){ 
                var LineValue= localStorage.getItem(localStorage.key(i));            
                finalStorageArr[i]=LineValue;
            }
            return finalStorageArr;
        }

        const finalStorageArr= setPurchase(LineValue0);
            
        var cartItem =(idKanap, color, quantity, nameKanap, priceKanap, imageUrlKanap, altTxtKanap)=>{
            //#1
            const cartItem = document.createElement('article');
            cartItem.classList.add('cart__item');
            cartItem.setAttribute('data-id',idKanap);
            cartItem.setAttribute('data-color',color);

            //#1.1    
            const itemImage = document.createElement('div');
            itemImage.classList.add('cart__item__img');
            //#1.2
            const itemContent = document.createElement('div');
            itemContent.classList.add('cart__item__content');

            //#1
            cartItem.appendChild(itemImage);//#1.1
            cartItem.appendChild(itemContent);//#1.2

            //#1.1.1
            const itemImageShown = document.createElement('img');
            itemImageShown.setAttribute('src', imageUrlKanap);
            itemImageShown.setAttribute('alt', altTxtKanap);

            //#1.1
            itemImage.appendChild(itemImageShown);//#1.1.1

            //#1.2.1
            const contentDescription =document.createElement('div');
            contentDescription.classList.add('cart__item__content__description');
            //#1.2.2
            const contentSettings =document.createElement('div');
            contentSettings.classList.add('cart__item__content__settings');

            //#1.2
            itemContent.appendChild(contentDescription);//#1.2.1
            itemContent.appendChild(contentSettings);//#1.2.2

            //#1.2.1.1
            const descriptionTheName = document.createElement('h2');
            descriptionTheName.textContent = nameKanap;
            //#1.2.1.2 
            const descriptionTheColor = document.createElement('p');
            descriptionTheColor.textContent = color;
            //#1.2.1.3
            const descriptionThePrice = document.createElement('p');
            descriptionThePrice.textContent = priceKanap;

            //#1.2.1
            contentDescription.appendChild(descriptionTheName)//   #1.2.1.1
            contentDescription.appendChild(descriptionTheColor);//#1.2.1.2
            contentDescription.appendChild(descriptionThePrice);// //#1.2.1.3

            //#1.2.2.1
            const settingsQuantity = document.createElement('div');
            settingsQuantity.classList.add('cart__item__content__settings__quantity');
            //#1.2.2.2
            const settingsDelete = document.createElement('div');
            settingsDelete.classList.add('cart__item__content__settings__delete');

            //#1.2.2
            contentSettings.appendChild(settingsQuantity);//#1.2.2.1
            contentSettings.appendChild(settingsDelete);//#1.2.2.2
            
            //#1.2.2.1.1
            const QuantityP = document.createElement('p');
            QuantityP.textContent ='Qté :';
            //#1.2.2.1.2
            const QuantityInput = document.createElement('input');
            QuantityInput.setAttribute('type','number');
            QuantityInput.setAttribute('name', 'ItemQuantity');
            QuantityInput.setAttribute('min', '1');
            QuantityInput.setAttribute('max','100');
            QuantityInput.setAttribute('value', quantity);

            //#1.2.2.1
            settingsQuantity.appendChild(QuantityP);//#1.2.2.1.1
            settingsQuantity.appendChild(QuantityInput);//#1.2.2.1.2

            //#1.2.2.2.1
            const DeleteP = document.createElement('p');
            DeleteP.classList.add('deleteItem');

            //#1.2.2.2
            settingsDelete.appendChild(DeleteP);//#1.2.2.2.1

            return cartItem;
        }

        const createArticle=(data, finalStorageArr)=>{  
            const cartItems = document.getElementById('cart__items');
            //parcours Storage (panier)
            for(let i=0; i<finalStorageArr.length; i++){
            
                var LineValue ="";
                LineValue = finalStorageArr[i];

                const regex = /[,]/;

                var index1 =LineValue.search(regex);

                var id = LineValue.substring(0,index1);
                console.log('id ='+id);

                var substringNot1 = LineValue.substring(index1+1);

                var index2 = substringNot1.search(regex);

                var color= substringNot1.substring(0,index2);
                console.log('color ='+color)

                var quantity= substringNot1.substring(index2+1);
                console.log('quantity ='+quantity);

                //recherche de l'élement du panier dans le catalogue
                var j=0;
                var idKanap = "";
                var nameKanap="";

                var priceKanap0 = 0;
                var priceKanap1 = "";
                var priceKanap= "";

                var imageUrlKanap = "";
                var altTxtKanap = "";
                

                do{
                    if(data[j]._id == id){
                        idKanap = data[j]._id;
                        nameKanap = data[j].name;

                        priceKanap0 = data[j].price;
                        priceKanap1 =priceKanap0.toString();
                        priceKanap= priceKanap1.substring(0,2) +','+priceKanap1.substring(2) + '€';

                        imageUrlKanap = data[j].imageUrl;
                        altTxtKanap = data[j].altTxt;
                    }
                    j++;
                }while(j<data.length);


                var cart = cartItem(idKanap, color, quantity, nameKanap, priceKanap, imageUrlKanap, altTxtKanap);

                cartItems.appendChild(cart);

            }
        }
                        
    createArticle(data, finalStorageArr);

    }    
        const main =async()=>{
            const LineValue0 = localStorage.getItem(localStorage.key(0));

            plier(LineValue0);
        }

        main();

    
